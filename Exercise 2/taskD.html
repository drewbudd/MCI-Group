<!doctype html>
<html>
<head>
<title>Human Capabilities - Reaction test</title> </head>
<body>
<script type="text/javascript">
	var experimentActive = false; 
	var testActive = false;
	var times = new Array();
	var lastTimeColorChanged;
	var falseEntryPic;
	var falseEntryAudio;
	var sheepPicShown;
	var sheepSoundPlayed;
	var sheepStimuli = 1;
	//document.getElementById("export").addEventListener('click', exportToCsv);
	
	function startExperiment() {
		document.getElementById("sheepImg").style.display = 'none';
		experimentActive = true;
		falseEntryPic = 0;
		falseEntryAudio = 0;
		sheepPicShown = 0;
		sheepSoundPlayed = 0;
		document.getElementById("text").innerHTML = "";
		document.getElementById("time").innerHTML = "";
		document.getElementById("count").innerHTML = "";
		document.getElementById("mean").innerHTML = "";
		document.getElementById("sd").innerHTML = "";
		document.getElementById("error").innerHTML = "";
		document.getElementById("instruction").innerHTML = "Press SPACE when you see or hear the sheep! Press 'a' for results!";
		startTest();
	}
	
	function startTest() {
		timeInSeconds = Math.random() * 4 + 2; // 2 - 6s
		window.setTimeout("showStimulus()", timeInSeconds * 1000);
	}
	
	function showStimulus() {
		if ((sheepPicShown >= sheepStimuli) && (sheepSoundPlayed >= sheepStimuli)) {
			testActive = false;
			stopExperiment();
		} else {
			testActive = true;
			sheepStimulus();
		}
	}
	
	function sheepStimulus() {
		
		if (sheepPicShown < sheepStimuli) {
			sheepPicShown++;
			document.getElementById("sheepImg").style.display = 'inline';
			lastTimeColorChanged = new Date().getTime();
		} else if (sheepSoundPlayed < sheepStimuli) {
			sheepSoundPlayed++;
			document.getElementById("sheepSnd").play();
			lastTimeColorChanged = new Date().getTime();
		} else {
			stopTest();
			stopExperiment();
			document.getElementById("instruction").innerHTML = "ERROR!";
		}
	}
	
	function stopTest() {
		document.getElementById("sheepImg").style.display = 'none';
		//document.getElementById("sheepSnd").stop();
		var currTime = new Date().getTime();
		var deltaTime = currTime - lastTimeColorChanged;
		times.push(deltaTime);
		document.getElementById("time").innerHTML = deltaTime + "ms";
		testActive = false;
		startTest();
	}
	
	function stopExperiment() {
		window.setTimeout("", 0);
		testActive = false;
		var meanDeltaTimePic = 0.0;
		for (var i = 0; i < sheepPicShown; ++i) {
			meanDeltaTimePic += times[i]; 
		}
		var meanDeltaTimeAudio = 0.0;
		for (var i = sheepPicShown; i < times.length; ++i) {
			meanDeltaTimeAudio += times[i]; 
		}		
		meanDeltaTimePic = Math.round(meanDeltaTimePic / sheepPicShown);
		meanDeltaTimeAudio = Math.round(meanDeltaTimeAudio / sheepSoundPlayed);
		var standardDeviationPic = 0.0;
		for (var i = 0; i < sheepPicShown; ++i) {
			var diff = (times[i] - meanDeltaTimePic);
			standardDeviationPic += diff * diff; 
		}
		var standardDeviationAudio = 0.0;
		for (var i = sheepPicShown; i < times.length; ++i) {
			var diff = (times[i] - meanDeltaTimeAudio);
			standardDeviationAudio += diff * diff; 
		}
		var errorRatePic = (falseEntryPic / (falseEntryPic + sheepPicShown)) * 100;
		var errorRateAudio = (falseEntryAudio / (falseEntryAudio + sheepSoundPlayed)) * 100;
		standardDeviationPic = Math.round(Math.sqrt(standardDeviationPic / sheepPicShown));
		standardDeviationAudio = Math.round(Math.sqrt(standardDeviationAudio / sheepPicShown));
		document.getElementById("count").innerHTML = "Count Picture: " + sheepPicShown + "<br/>" + "Count Sound: " + sheepSoundPlayed;
		document.getElementById("mean").innerHTML = "Mean Picture: " + meanDeltaTimePic + "ms" + "<br/>" + "Mean Sound: " + meanDeltaTimeAudio + "ms";
		document.getElementById("sd").innerHTML = "SD Picture: " + standardDeviationPic +	"ms" + "<br/>" + "SD Sound: " + standardDeviationAudio +	"ms";
		document.getElementById("error").innerHTML = "Error rate Picture: " + errorRatePic.toFixed(2) + "%" + "<br/>" + "Error rate Sound: " + errorRateAudio.toFixed(2) + "%";
		document.getElementById("instruction").innerHTML = "Press SPACE to start!";
		times = [];
		experimentActive = false;
		document.getElementById("export").style.display = 'inline';
	}
	
	function changeTextColor(newColor) {
		document.getElementById("text").style.color = newColor;
		document.getElementById("text").style.backgroundColor = newColor;
		lastTimeColorChanged = new Date().getTime();
	}
	
	document.onkeydown = function onKey(e) { 
		
		if (e == null) {
			e = window.event;
		}
		
		switch (e.which || e.charCode || e.keyCode) {
			case 32:
			// space
				if (!experimentActive) {
					startExperiment(); 
				}
				else {
					if (testActive) {
						stopTest();
					} else {
						if (sheepPicShown < sheepStimuli){
							falseEntryPic++;
						} else {
							falseEntryAudio++;
						}
					}
				}
				break;
			case 65: // a
				if (experimentActive) {
					stopExperiment();
				}
				break;
			//case 66:
				// b
				// here you can extend... alert("pressed the b key"); break;
				//break;
		}
		
	}
	
	function exportToCsv() {
		var myCsv = "Col1,Col2,Col3\nval1,val2,val3";

		window.open('data:text/csv;charset=utf-8,' + escape(myCsv));
	}

	
</script>
		<h1><p id="text">User Study</p></h1>
		<h1 id="instruction">Press SPACE to start!</h1>
		<p><img id="sheepImg" src="sheep.jpg" style="display:none"></p>
		<audio id="sheepSnd" src="sheep.wav" preload="auto"></audio>
		<p>
		<p id="time"></p> <p id="count"></p> <p id="mean"></p> <p id="sd"></p> <p id="error"></p> 
		<p>
		<button id="export" onclick="exportToCsv()" style="display:none">export results to CSV</button>
		</p>
	</body>
</html>
