<!doctype html>
<html>
<head>
<title>Human Capabilities - Reaction test</title> </head>
<body>
<script type="text/javascript">
	var experimentActive = false;
	var testActive = false;
	var resetting = false;
	var sheepTimes = new Array();
	var timeStimulusStarted;
	var falseEntryPic;
	var falseEntryAudio;
	var sheepPicShown;
	var sheepSoundPlayed;
	var sheepStimuli = 3;
	var myCsv = "";


	function startExperiment() {
		document.getElementById("sheepImg").style.display = 'none';
		document.getElementById("export").style.display = 'none';
		experimentActive = true;
		falseEntryPic = 0;
		falseEntryAudio = 0;
		sheepPicShown = 0;
		sheepSoundPlayed = 0;
		document.getElementById("text").innerHTML = "";
		document.getElementById("time").innerHTML = "";
		document.getElementById("count").innerHTML = "";
		document.getElementById("mean").innerHTML = "";
		document.getElementById("sd").innerHTML = "";
		document.getElementById("error").innerHTML = "";
		document.getElementById("sheepSource").innerHTML = "";
		document.getElementById("instruction").innerHTML = "Press SPACE when you see or hear the sheep! Press 'a' for results!";
		startTest();
	}

	function startTest() {
		if ((sheepPicShown >= sheepStimuli) && (sheepSoundPlayed >= sheepStimuli)) {
			testActive = false;
			stopExperiment();
		} else {
			timeInSeconds = Math.random() * 4 + 2; // 2 - 6s
			window.setTimeout("showStimulus()", timeInSeconds * 1000);
		}
	}

	function showStimulus() {
		testActive = true;
		sheepStimulus();
		//choiceStimulus();
	}

	function sheepStimulus() {

		if (sheepPicShown < sheepStimuli) {
			sheepPicShown++;
			document.getElementById("sheepImg").style.display = 'inline';
			timeStimulusStarted = new Date().getTime();
		} else if (sheepSoundPlayed < sheepStimuli) {
			sheepSoundPlayed++;
			document.getElementById("sheepSnd").play();
			timeStimulusStarted = new Date().getTime();
		} else {
			stopTest();
			stopExperiment();
			document.getElementById("instruction").innerHTML = "ERROR!";
		}
	}

	function choiceStimulus() {
		timeStimulusStarted = new Date().getTime();
		var canvas = document.getElementById('circle');
		if (Math.random() < 0.5) {
			if (canvas.getContext) {
				var ctx = canvas.getContext('2d');
				var X = canvas.width / 2;
				var Y = canvas.height / 2;
				var R = (Math.random() * 100) + 75;

				ctx.beginPath();
				ctx.arc(X, Y, R, 0, 2 * Math.PI, false);
				ctx.fillStyle = 'black';
				ctx.fill();
			}
		} else {
			if (canvas.getContext) {
				var ctx = canvas.getContext('2d');
				var H = (Math.random() * 100) + 75;
				ctx.rect((canvas.width/2) - (H/2) ,(canvas.height/2) - (H/2),H,H);
				ctx.fillStyle = 'black';
				ctx.fill();
			}
		}
	}

	function stopTest() {
		document.getElementById("sheepImg").style.display = 'none';
		document.getElementById('circle').getContext('2d').rect(0, 0, 350, 350);
		document.getElementById('circle').getContext('2d').fillStyle= 'white';
		document.getElementById('circle').getContext('2d').fill();
		var currTime = new Date().getTime();
		var deltaTime = currTime - timeStimulusStarted;
		sheepTimes.push(deltaTime);
		document.getElementById("time").innerHTML = deltaTime + "ms";
		testActive = false;
		startTest();
	}

	function stopExperiment() {
		window.setTimeout("", 0);
		testActive = false;
		var meanDeltaTimePic = calcMeanDeltaTime(sheepTimes, 0, sheepPicShown);

		var meanDeltaTimeAudio = calcMeanDeltaTime(sheepTimes, sheepPicShown, sheepTimes.length);

		meanDeltaTimePic = Math.round(meanDeltaTimePic / sheepPicShown);
		meanDeltaTimeAudio = Math.round(meanDeltaTimeAudio / sheepSoundPlayed);
		var standardDeviationPic = 0.0;
		for (var i = 0; i < sheepPicShown; ++i) {
			var diff = (sheepTimes[i] - meanDeltaTimePic);
			standardDeviationPic += diff * diff;
		}
		var standardDeviationAudio = 0.0;
		for (var i = sheepPicShown; i < sheepTimes.length; ++i) {
			var diff = (sheepTimes[i] - meanDeltaTimeAudio);
			standardDeviationAudio += diff * diff;
		}
		var errorRatePic = (falseEntryPic / (falseEntryPic + sheepPicShown)) * 100;
		var errorRateAudio = (falseEntryAudio / (falseEntryAudio + sheepSoundPlayed)) * 100;

		// calculate std dev
		standardDeviationPic = Math.round(Math.sqrt(standardDeviationPic / sheepPicShown));
		standardDeviationAudio = Math.round(Math.sqrt(standardDeviationAudio / sheepPicShown));

		// display results
		document.getElementById("count").innerHTML = "Count Picture: " + sheepPicShown + "<br/>" + "Count Sound: " + sheepSoundPlayed;
		document.getElementById("mean").innerHTML = "Mean Picture: " + meanDeltaTimePic + "ms" + "<br/>" + "Mean Sound: " + meanDeltaTimeAudio + "ms";
		document.getElementById("sd").innerHTML = "SD Picture: " + standardDeviationPic +	"ms" + "<br/>" + "SD Sound: " + standardDeviationAudio +	"ms";
		document.getElementById("error").innerHTML = "Error rate Picture: " + errorRatePic.toFixed(2) + "%" + "<br/>" + "Error rate Sound: " + errorRateAudio.toFixed(2) + "%";
		document.getElementById("instruction").innerHTML = 'Please wait...resetting experiment';

		resetting = true;
		window.setTimeout("showStart()", 6000);

		// export times before clearing
		myCsv = "Data,\n";

		myCsv += "Picture,";
		for (var i=0; i < sheepPicShown; ++i) {
			myCsv += sheepTimes[i] + ",";
		}
		myCsv += "Count," + sheepPicShown + ",Mean," + meanDeltaTimePic + ",SD," + standardDeviationPic + ",Error Rate," + errorRatePic + ",";

		myCsv += "\nAudio,";
		for (var i=sheepPicShown; i < sheepTimes.length; ++i) {
			myCsv += sheepTimes[i] + ",";
		}
		myCsv += "Count," + sheepSoundPlayed + ",Mean," + meanDeltaTimeAudio + ",SD," + standardDeviationAudio + ",Error Rate," + errorRateAudio + ",";

		// reset variables to starting state
		sheepTimes = [];
		experimentActive = false;
		document.getElementById("export").style.display = 'inline';

		// make sure image is shown with source link
		document.getElementById("sheepImg").style.display = 'inline';
		document.getElementById("sheepSource").innerHTML = 'image source(<a href="https://pixabay.com/en/sheep-lamb-lambs-animals-348956/">https://pixabay.com/en/sheep-lamb-lambs-animals-348956/</a>)';
	}

function calcMeanDeltaTime(times, start, end) {
	var meanDeltaTime = 0.0;
	for (var i = start; i < end; ++i) {
		meanDeltaTime += times[i];
	}

	return meanDeltaTime;
}

/*
	function displayResults(count, mean, stdDev, errorRate) {
		document.getElementById("count").innerHTML = "Count Picture: " + sheepPicShown + "<br/>" + "Count Sound: " + sheepSoundPlayed;
		document.getElementById("mean").innerHTML = "Mean Picture: " + meanDeltaTimePic + "ms" + "<br/>" + "Mean Sound: " + meanDeltaTimeAudio + "ms";
		document.getElementById("sd").innerHTML = "SD Picture: " + standardDeviationPic +	"ms" + "<br/>" + "SD Sound: " + standardDeviationAudio +	"ms";
		document.getElementById("error").innerHTML = "Error rate Picture: " + errorRatePic.toFixed(2) + "%" + "<br/>" + "Error rate Sound: " + errorRateAudio.toFixed(2) + "%";
	}
	*/

	// to delete! fucking shit!
	function changeTextColor(newColor) {
		document.getElementById("text").style.color = newColor;
		document.getElementById("text").style.backgroundColor = newColor;
		timeStimulusStarted = new Date().getTime();
	}

	document.onkeydown = function onKey(e) {

		if (e == null) {
			e = window.event;
		}

		switch (e.which || e.charCode || e.keyCode) {
			case 32:
			// space
				if (testActive && !resetting) {
					stopTest();
				} else {
					if (sheepPicShown < sheepStimuli){
						falseEntryPic++;
					} else {
						falseEntryAudio++;
					}
				}
				break;
			case 65: // a
				if (experimentActive) {
					stopExperiment();
				}
				break;
			case 83: //s
				if (!experimentActive && !resetting) {
					startExperiment();
				}
				break;
				// here you can extend... alert("pressed the b key"); break;
				//break;
		}

	}

	function exportToCsv() {
		window.open('data:text/csv;charset=utf-8,' + escape(myCsv));
	}

	function showStart() {
		document.getElementById("instruction").innerHTML = 'Press "S" to start!';
		resetting = false;
	}


</script>
		<h1><p id="text">User Study</p></h1>
		<h1 id="instruction">Press "S" to start!</h1>
		<p><img id="sheepImg" src="sheep.jpg" style="display:none"></p>
		<p id="sheepSource"></p>
		<audio id="sheepSnd" src="sheep.wav" preload="auto"></audio>
		<canvas id="circle" width="350" height="350"></canvas>
		<p>
		<p id="time"></p> <p id="count"></p> <p id="mean"></p> <p id="sd"></p> <p id="error"></p>
		<p>
		<button id="export" onclick="exportToCsv()" style="display:none">export results to CSV</button>
		</p>
	</body>
</html>
